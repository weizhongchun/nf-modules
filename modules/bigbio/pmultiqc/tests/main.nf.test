nextflow_process {

    name "Test Process PMULTIQC"
    script "../main.nf"
    process "PMULTIQC"
    tag "modules"
    tag "modules_bigbio"
    tag "pmultiqc"

    test("Should generate MultiQC report") {

        when {
            process {
                """
                input[0] = [
                    [ id: 'test' ],
                    file(params.test_data['proteomics']['qc']['results'], checkIfExists: false)
                ]
                """
            }
        }

        then {
            assert process.success
            assert snapshot(process.out.versions).match("versions")
            assert process.out.report.size() == 1
            assert process.out.data.size() == 1
        }
    }

    test("Should run stub mode") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [ id: 'test_sample' ],
                    file(params.test_data['proteomics']['qc']['results'], checkIfExists: false)
                ]
                """
            }
        }

        then {
            assert process.success
            assert snapshot(process.out.versions).match("versions_stub")
            assert new File(process.out.report[0][1]).name == 'test_sample_multiqc_report.html'
            assert process.out.data.size() == 1
        }
    }

    test("Should generate MultiQC report for DIANN") {

        when {
            params {
                process {
                    withName: 'PMULTIQC' {
                        ext.args = '--quantification_method diann'
                    }
                }
            }
            process {
                """
                input[0] = [
                    [ id: 'DIANN_test' ],
                    file(params.test_data['proteomics']['qc']['diann_results'], checkIfExists: false)
                ]
                """
            }
        }

        then {
            assert process.success
            assert snapshot(process.out.versions).match("versions")
            assert process.out.report.size() == 1
            assert process.out.data.size() == 1
        }
    }

    test("Should generate MultiQC report for quantms") {

        when {
            params {
                process {
                    withName: 'PMULTIQC' {
                        ext.args = '--quantms_plugin --quantification_method lfq'
                    }
                }
            }
            process {
                """
                input[0] = [
                    [ id: 'quantms_test' ],
                    file(params.test_data['proteomics']['qc']['quantms_results'], checkIfExists: false)
                ]
                """
            }
        }

        then {
            assert process.success
            assert snapshot(process.out.versions).match("versions")
            assert process.out.report.size() == 1
            assert process.out.data.size() == 1
            // quantms may generate a database file
            if (process.out.quantmsdb.size() > 0) {
                assert process.out.quantmsdb[0].name.endsWith('.db')
            }
        }
    }
}
